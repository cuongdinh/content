commonfields:
  id: ThreatMiner
  version: -1
name: ThreatMiner
display: ThreatMiner
category: Data Enrichment & Threat Intelligence
image: data:image/png;base64,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
description: Data Mining for Threat Intelligence
configuration:
- display: ""
  name: limitResults
  defaultvalue: "30"
  type: 0
  required: false
- display: ""
  name: unsecure
  defaultvalue: "False"
  type: 0
  required: false
- display: ""
  name: proxy
  defaultvalue: "True"
  type: 0
  required: false
- display: ""
  name: threatminerUrl
  defaultvalue: https://api.threatminer.org/v2/
  type: 0
  required: true
script:
  script: |
    # VERIFY_CERTIFICATES = False if demisto.params().get('unsecure') else True
    VERIFY_CERTIFICATES = True

    ''' IMPORTS '''
    import datetime
    import time
    import requests
    import json

    THREAT_MINER_URL= demisto.params().get('threatminerUrl')
    DEFAULT_HEADERS = {
      "Content-Type": "application/json"
    }
    MAX_RETURNED_ARRAY_SIZE = 30


    ''' HELPER FUNCTIONS '''
    def http_request(method, url, headers):
        try:
            res = requests.request(method,
                                    url,
                                    verify=VERIFY_CERTIFICATES,
                                    headers=headers)

            if res.status_code == 200:
                return res.json()
            # 204 HTTP status code is returned when api rate limit has been exceeded
            elif res.status_code == 204:
                return_error("You've reached your API call quota.")
            elif res.status_code == 404:
                return {}

            res.raise_for_status()

        except Exception, e:
            raise(e)

    def get_domain_whois_rawdata(domainName):
        threatMinerDomainUrlPostfix = 'domain.php?q={}&rt={}'.format(domainName, 1)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        domainWhois = response.get('results',[])
        if len(domainWhois) == 0:
            return {}

        return domainWhois[0]

    def get_domain_whois(whois):
        return {
                    'Domain Name': whois['domain'],
                    'Server': whois['whois']['whois_server'],
                    'Create Date': whois['whois']['creation_date'],
                    'Update Date': whois['whois']['updated_date'],
                    'Expiration': whois['whois']['expiration_date'],
                    'Name Servers': whois['whois']['nameservers']
                }

    def get_domain_passiveDns_rawdata(domainName):
        threatMinerDomainUrlPostfix = 'domain.php?q={}&rt={}'.format(domainName, 2)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        threatminerResultsAsArray = response.get('results',[])
        if len(threatminerResultsAsArray) == 0:
            return []

        return threatminerResultsAsArray

    def get_domain_passiveDns(passiveDns, maxReturnedArraySize):
        if maxReturnedArraySize == -1:
            return passiveDns['PassiveDNS']
        return passiveDns[:maxReturnedArraySize]

    def get_domain_subdomains_rawdata(domainName):
        threatMinerDomainUrlPostfix = 'domain.php?q={}&rt={}'.format(domainName, 5)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        subDomainsArray = response.get('results',[])
        return subDomainsArray

    def get_domain_subdomains(subDomainsArray, maxReturnedArraySize):
        subDomains = []
        if len(subDomainsArray) > 0:
            if maxReturnedArraySize == -1:
                return subDomainsArray
            subDomains = subDomainsArray[:maxReturnedArraySize]

        return subDomains;

    def get_domain_URI_rawdata(domainName):
        threatMinerDomainUrlPostfix = 'domain.php?q={}&rt={}'.format(domainName, 3)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        urisFullResult = response.get('results',[])
        return urisFullResult

    def get_domain_URI(urisRawData, maxReturnedArraySize):
        uriCounter = 0
        uris = []
        for uriInfo in urisRawData:
            if maxReturnedArraySize == -1 or uriCounter < maxReturnedArraySize:
                uris.append({
                    'Address': uriInfo['uri'],
                    'Last Seen': uriInfo['last_seen']
                })
                uriCounter += 1
            else:
                break

        return uris

    def get_domain_MD5_rawdata(domainName):
        threatMinerDomainUrlPostfix = 'domain.php?q={}&rt={}'.format(domainName, 4)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        md5s = response.get('results',[])
        return md5s

    def get_domain_MD5(md5s, maxReturnedArraySize):
        if len(md5s) == 0:
            return []

        if maxReturnedArraySize == -1:
            return md5s

        return md5s[:maxReturnedArraySize]

    def create_domain_command_markdown(domain, domainWhois, domainPassiveDNS, subDomains, domainUris, domainHashes):

        md = '## ThreatMiner Domain report for: {}\n'.format(domain)
        threadMinerFoundResults = False

        if len(domainWhois) != 0:
            md += tableToMarkdown("Whois for {} domain".format(domain), domainWhois, ['Domain Name', 'Server', 'Create Date', 'Update Date', 'Expiration', 'Name Servers'])
            threadMinerFoundResults = True
        if len(domainPassiveDNS) != 0:
            md += tableToMarkdown("PassiveDNS for {} domain".format(domain), domainPassiveDNS, ['ip', 'first_seen', 'last_seen'])
            threadMinerFoundResults = True
        if len(subDomains) != 0:
            md += tableToMarkdown("{} Subdomains".format(domain), subDomains, ['Subdomains'])
            threadMinerFoundResults = True
        if len(domainUris) != 0:
            md += tableToMarkdown("{} URIs".format(domain), domainUris, ['Address','Last Seen'])
            threadMinerFoundResults = True
        if len(domainHashes) != 0:
            md += tableToMarkdown("{} Related Samples(hash only)".format(domain), domainHashes, ['hashes'])
            threadMinerFoundResults = True

        if threadMinerFoundResults == False:
            md += 'No results found'

        return md

    def get_domain_report(domainName, maxReturnedArraySize):
        context = {}
        content = []

        whoisRawData = get_domain_whois_rawdata(domainName)
        domainWhois = get_domain_whois(whoisRawData)

        passiveDNSRawData = get_domain_passiveDns_rawdata(domainName)
        passiveDNS = get_domain_passiveDns(passiveDNSRawData, maxReturnedArraySize)

        subdomainsRawData = get_domain_subdomains_rawdata(domainName)
        subdomains = get_domain_subdomains(subdomainsRawData, maxReturnedArraySize)

        uriRawData = get_domain_URI_rawdata(domainName)
        domainURIs = get_domain_URI(uriRawData, maxReturnedArraySize)

        md5RawData = get_domain_MD5_rawdata(domainName)
        domainMD5 = get_domain_MD5(md5RawData, maxReturnedArraySize)

        content.append(whoisRawData)
        content.append(passiveDNSRawData)
        content.append(subdomainsRawData)
        content.append(uriRawData)
        content.append(md5RawData)

        context['ThreatMiner.Domain.Whois'] = domainWhois
        context['ThreatMiner.Domain.PassiveDNS'] = passiveDNS
        context['ThreatMiner.Domain.Subdomains'] = subdomains
        context['ThreatMiner.Domain.URI'] = domainURIs
        context['ThreatMiner.Domain.MD5'] = domainMD5

        markdown = create_domain_command_markdown(domainName, domainWhois , passiveDNS, subdomains, domainURIs, domainMD5)
        return [{'Type': entryTypes['note'],
                'Contents': content,
                'HumanReadable': markdown,
                'EntryContext': createContext(context, removeNull=True),
                'ContentsFormat': formats['json']}]

    def get_ip_whois_rawdata(whoisRawData):
        threatMinerIpUrlPostfix = 'host.php?q={}&rt={}'.format(ipAddress, 1)
        response = http_request('GET',THREAT_MINER_URL + threatMinerIpUrlPostfix, DEFAULT_HEADERS)
        whoisRawdata = response.get('results',[])

        return whoisRawdata[0]

    def get_ip_whois(whoisRawdata):

        ipWhoisResults = {}
        # ipWhoisResults['Address'] = ipAddress #TODO: fix it to take ip
        ipWhoisResults['Reverse'] = whoisRawdata['reverse_name']
        ipWhoisResults['Bgp'] = whoisRawdata['bgp_prefix']
        ipWhoisResults['Country'] = whoisRawdata['cc']
        ipWhoisResults['ASN'] = whoisRawdata['asn']
        ipWhoisResults['Org'] = whoisRawdata['org_name']

        return ipWhoisResults

    def get_ip_passiveDNS_rawdata(ipAddress):
        threatMinerIpUrlPostfix = 'host.php?q={}&rt={}'.format(ipAddress, 2)
        response = http_request('GET',THREAT_MINER_URL + threatMinerIpUrlPostfix, DEFAULT_HEADERS)
        passiveDNSArray = response.get('results',[])

        return passiveDNSArray

    def get_ip_passiveDNS(passiveDNSArray, maxReturnedArraySize):
        if len(passiveDNSArray) == 0:
            return []

        if maxReturnedArraySize == -1:
            return passiveDNSArray;

        return passiveDNSArray[:maxReturnedArraySize]


    def get_ip_URI_rawdata(ipAddress):
        threatMinerIpUrlPostfix = 'host.php?q={}&rt={}'.format(ipAddress, 3)
        response = http_request('GET',THREAT_MINER_URL + threatMinerIpUrlPostfix, DEFAULT_HEADERS)
        urisRawdata = response.get('results',[])
        return urisRawdata

    def get_ip_URI(threatminerResultsAsArray, maxReturnedArraySize):

        uriCounter = 0
        URIs = []

        for uri in threatminerResultsAsArray:
            if maxReturnedArraySize == -1 or uriCounter < maxReturnedArraySize:
                URIs.append({
                    'UriAddress':threatminerResultsAsArray[uriCounter]['uri'],
                    'LastSeen':threatminerResultsAsArray[uriCounter]['last_seen']
                    })
                uriCounter += 1
            else:
                break

        return URIs

    def get_ip_MD5_rawdata(ipAddress):
        threatMinerDomainUrlPostfix = 'host.php?q={}&rt={}'.format(ipAddress, 4)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)

        md5s = response.get('results',[])

        if len(md5s) == 0:
            return []
        return md5s

    def get_ip_MD5(md5sRawData, maxReturnedArraySize):
        if maxReturnedArraySize == -1:
            return md5sRawData
        return md5sRawData[:maxReturnedArraySize]

    def get_ip_SSL_rawdata(ipAddress):
        threatMinerDomainUrlPostfix = 'host.php?q={}&rt={}'.format(ipAddress, 5)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)

        sslsRawData = response.get('results',[])
        return sslsRawData

    def get_ip_SSL(ssls, maxReturnedArraySize):
        if len(ssls) == 0:
            return ssls

        if maxReturnedArraySize == -1:
            return ssls;

        return ssls[:maxReturnedArraySize]

    def create_ip_command_markdown(ipAddress, ipWhois, passiveDNS, uris, relatedSamples, ssls):

        md = '## ThreatMiner IP report for: {}\n'.format(ipAddress)
        threadMinerFoundResults = False

        if len(ipWhois) != 0:
            md += tableToMarkdown("Whois for {}".format(ipAddress), ipWhois, ['Address', 'Country', 'Org', 'Bgp', 'Reverse', 'ASN'])
            threadMinerFoundResults = True
        if len(passiveDNS) != 0:
            md += tableToMarkdown("PassiveDNS for {}".format(ipAddress), passiveDNS, ['domain', 'first_seen', 'last_seen'])
            threadMinerFoundResults = True
        if len(uris) != 0:
            md += tableToMarkdown("{} URIs".format(ipAddress), uris, ['UriAddress','LastSeen'])
            threadMinerFoundResults = True
        if len(relatedSamples) != 0:
            md += tableToMarkdown("{} MD5s".format(ipAddress), relatedSamples, ['MD5'])
            threadMinerFoundResults = True
        if len(ssls) != 0:
            md += tableToMarkdown("{} SSLs".format(ipAddress), ssls, ['SSL'])
            threadMinerFoundResults = True

        if threadMinerFoundResults == False:
            md += 'No results found'

        return md

    def get_ip_report(ipAddress, maxReturnedArraySize):
        context = {}
        content = []

        whoisRawData = get_ip_whois_rawdata(ipAddress)
        ipWhois = get_ip_whois(whoisRawData)

        passiveDNSRawData = get_ip_passiveDNS_rawdata(ipAddress)
        ipPassiveDNS = get_ip_passiveDNS(passiveDNSRawData, maxReturnedArraySize)

        md5RawData = get_ip_MD5_rawdata(ipAddress)
        ipMD5 = get_ip_MD5(md5RawData, maxReturnedArraySize)

        uriRawData = get_ip_URI_rawdata(ipAddress)
        ipURI = get_ip_URI(uriRawData, maxReturnedArraySize)

        sslRawData = get_ip_SSL_rawdata(ipAddress)
        ipSSL = get_ip_SSL(sslRawData, maxReturnedArraySize)

        content.append(whoisRawData)
        content.append(passiveDNSRawData)
        content.append(md5RawData)
        content.append(uriRawData)
        content.append(sslRawData)

        context['ThreatMiner.IP.Whois'] = ipWhois
        context['ThreatMiner.IP.PassiveDNS'] = ipPassiveDNS
        context['ThreatMiner.IP.MD5'] = ipMD5
        context['ThreatMiner.IP.URI'] = ipURI
        context['ThreatMiner.IP.SSL'] = ipSSL

        markdown = create_ip_command_markdown(ipAddress, ipWhois, ipPassiveDNS, ipURI, ipMD5, ipSSL)

        return [{'Type': entryTypes['note'],
                'Contents': content,
                'HumanReadable': markdown,
                'EntryContext': createContext(context, removeNull=True),
                'ContentsFormat': formats['json']}]

    def get_file_whois_rawdata(hashedFile):
        threatMinerIpUrlPostfix = 'sample.php?q={}&rt={}'.format(hashedFile, 1)
        response = http_request('GET',THREAT_MINER_URL + threatMinerIpUrlPostfix, DEFAULT_HEADERS)
        threatminerResultsAsArray = response.get('results',[])

        if len(threatminerResultsAsArray) == 0:
            return threatminerResultsAsArray

        return threatminerResultsAsArray[0]

    def get_file_whois(rawdataFile):
        if len(rawdataFile) == 0:
            return rawdataFile

        whoisResult = {}
        whoisResult['MD5'] = rawdataFile['md5']
        whoisResult['Architecture'] = rawdataFile['architecture']
        whoisResult['Sha1'] = rawdataFile['sha1']
        whoisResult['Sha256'] = rawdataFile['sha256']
        whoisResult['Type'] = rawdataFile['file_type']
        whoisResult['FileName'] = rawdataFile['file_name']
        whoisResult['Size'] = rawdataFile['file_size']
        whoisResult['Analyzed'] = rawdataFile['date_analysed']

        return whoisResult

    def get_file_http_rawdata(hashedFile):
        threatMinerDomainUrlPostfix = 'sample.php?q={}&rt={}'.format(hashedFile, 2)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        fileHttpRawData = response.get('results',[])
        return fileHttpRawData

    def get_file_http(fileHttpRawData, maxReturnedArraySize):
        if len(fileHttpRawData) == 0:
            return []

        fileHttp = fileHttpRawData[0]
        httpTraffics = fileHttp['http_traffic']

        httpTrafficCounter = 0
        httpTrafficsInfo = []

        for httpTraffic in httpTraffics:
            if maxReturnedArraySize == -1 or httpTrafficCounter < maxReturnedArraySize:
                httpTrafficsInfo.append({
                    'Domain': httpTraffics[httpTrafficCounter]['domain'],
                    'URL': httpTraffics[httpTrafficCounter]['url'],
                    'UserAgent': httpTraffics[httpTrafficCounter]['user_agent']
                })
                httpTrafficCounter += 1
            else:
                break

        return httpTrafficsInfo

    def get_file_domainsAndIp_rawdata(hashedFile):
        threatMinerDomainUrlPostfix = 'sample.php?q={}&rt={}'.format(hashedFile, 3)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        domainAndIpRawData = response.get('results',[])
        return domainAndIpRawData

    def get_file_domainsAndIp(domainAndIpRawData, maxReturnedArraySize):
        if len(domainAndIpRawData) == 0:
            return []

        threatminerResult = domainAndIpRawData[0]
        fileDomains = threatminerResult['domains']
        if maxReturnedArraySize == -1:
            return fileDomains
        return fileDomains[:maxReturnedArraySize]


    def get_file_mutants_rawdata(hashedFile):
        threatMinerDomainUrlPostfix = 'sample.php?q={}&rt={}'.format(hashedFile, 4)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)
        mutantsRawdata = response.get('results',[])
        return mutantsRawdata

    def get_file_mutants(mutantsRawdata, maxReturnedArraySize):
        if len(mutantsRawdata) == 0:
            return []

        fileMutants = mutantsRawdata[0]
        if maxReturnedArraySize == -1:
            return fileMutants['mutants']
        return fileMutants['mutants'][:maxReturnedArraySize]

    def get_file_registry_keys_rawdata(hashedFile):
        threatMinerDomainUrlPostfix = 'sample.php?q={}&rt={}'.format(hashedFile, 5)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)

        threatminerResultsAsArray = response.get('results',[])
        if len(threatminerResultsAsArray)  == 0:
            return []
        return threatminerResultsAsArray[0]

    def get_file_registry_keys(fileRegistryKeys, maxReturnedArraySize):
        if len(fileRegistryKeys)  == 0:
            return []

        if maxReturnedArraySize == -1:
            return fileRegistryKeys['registry_keys']
        return fileRegistryKeys['registry_keys'][:maxReturnedArraySize]

    def get_file_AV_detection_rawdata(hashedFile):
        threatMinerDomainUrlPostfix = 'sample.php?q={}&rt={}'.format(hashedFile, 6)
        response = http_request('GET',THREAT_MINER_URL + threatMinerDomainUrlPostfix, DEFAULT_HEADERS)

        rawFileAvDectection = response.get('results',[])
        return rawFileAvDectection

    def get_file_AV_detection(rawFileAvDectection):
        if len(rawFileAvDectection) == 0:
            return []

        fileAVDetection = rawFileAvDectection[0]

        return fileAVDetection['av_detections']


    def get_file_report(hashedFile, maxReturnedArraySize):
        context = {}
        content = []

        fileWhoIsRawData = get_file_whois_rawdata(hashedFile)
        fileWhoIs = get_file_whois(fileWhoIsRawData)

        fileHttpsRawData = get_file_http_rawdata(hashedFile)
        fileHttps = get_file_http(fileHttpsRawData, maxReturnedArraySize)

        fileDomainsRawData = get_file_domainsAndIp_rawdata(hashedFile)
        fileDomains = get_file_domainsAndIp(fileDomainsRawData, maxReturnedArraySize)

        fileMutantsRawData = get_file_mutants_rawdata(hashedFile)
        fileMutants = get_file_mutants(fileMutantsRawData, maxReturnedArraySize)

        fileRegistryKeysRawData = get_file_registry_keys_rawdata(hashedFile)
        fileRegistryKeys = get_file_registry_keys(fileRegistryKeysRawData, maxReturnedArraySize)

        rawFileAvDectection = get_file_AV_detection_rawdata(hashedFile)
        fileAntiVirus = get_file_AV_detection(rawFileAvDectection)

        content.append(fileWhoIsRawData)
        content.append(fileHttpsRawData)
        content.append(fileDomainsRawData)
        content.append(fileMutantsRawData)
        content.append(fileRegistryKeysRawData)
        content.append(rawFileAvDectection)


        context['ThreatMiner.File'] = fileWhoIs
        context['ThreatMiner.File.HTTP'] = fileHttps
        context['ThreatMiner.File.Domains'] = fileDomains
        context['ThreatMiner.File.Mutants'] = fileMutants
        context['ThreatMiner.File.Registry'] = fileRegistryKeys
        context['ThreatMiner.File.AV'] = fileAntiVirus[:maxReturnedArraySize]

        file = {}
        file['Whois'] = fileWhoIs
        file['MD5'] = fileWhoIs['MD5']
        file['HTTP'] = fileHttps
        file['Domains'] = fileDomains
        file['Mutants'] = fileMutants
        file['Registry'] = fileRegistryKeys
        file['AV'] = fileAntiVirus[:maxReturnedArraySize]

        # context['File.MD5'] = fileWhoIs['MD5']
        # context['File.Sha1'] = fileWhoIs['Sha1']
        # context['File.Sha256'] = fileWhoIs['Sha256']

        amountOfDetections = len(fileAntiVirus)

        dbot_scores = get_dbot_score_report(amountOfDetections, hashedFile, context)

        markDownResult = create_file_command_markdown(hashedFile, fileWhoIs, fileHttps, fileDomains, fileMutants, fileRegistryKeys, fileAntiVirus[:maxReturnedArraySize])

        context2 = {
            'File(val.MD5 == obj.MD5)': createContext(file, removeNull=True),
            'ThreatMiner.File(val.MD5 == obj.MD5)':  createContext(context, removeNull=True),
            'DBotScore(val.Vendor && val.Indicator && val.Vendor == obj.Vendor && val.Indicator == obj.Indicator)': createContext(dbot_scores, removeNull=True)
        }

        return [{'Type': entryTypes['note'],
                'Contents': content,
                'HumanReadable': markDownResult,
                'EntryContext': context2,
                'ContentsFormat': formats['json']}]

    def get_dbot_score_report(amountOfDetections, hashedFile, context):
        dbot = {}
        dbot['Indicator'] = hashedFile
        dbot['Type'] = 'File'
        dbot['Vendor'] = 'ThreatMiner'
        dbot_score = get_dbot_score(amountOfDetections)
        if dbot_score == 3:
            context['File.Malicious.Vendor'] = 'ThreatMiner'
            context['File.Malicious.Detections'] = amountOfDetections
        return dbot

    def get_dbot_score(amountOfDetections):
        maliciousThreshold = int(demisto.args().get('threshold'))
        if amountOfDetections == 0:
            return 0
        if amountOfDetections > 0 and amountOfDetections < maliciousThreshold:
            return 2
        if amountOfDetections >= maliciousThreshold:
            return 3

    def create_file_command_markdown(hashedFile, fileWhois, fileHttp, domains, mutants, registryKeys, antiVirusDetection):

        md = '## ThreatMiner file report for hashed file: {}\n'.format(hashedFile)
        threadMinerFoundResults = False

        if len(fileWhois) != 0:
            md += tableToMarkdown("Whois for hashed file {}".format(hashedFile), fileWhois, ['MD5', 'Architecture', 'Sha1', 'Sha256', 'Type', 'FileName', 'Size', 'Analyzed'])
            threadMinerFoundResults = True
        if len(fileHttp) != 0:
            md += tableToMarkdown("HTTP for hashed file {}".format(hashedFile), fileHttp, ['Domain', 'URL', 'UserAgent'])
            threadMinerFoundResults = True
        if len(domains) != 0:
            md += tableToMarkdown("Hashed file: {} Domains".format(hashedFile), domains, ['domain','ip'])
            threadMinerFoundResults = True
        if len(mutants) != 0:
            md += tableToMarkdown("Hashed file: {} Mutants".format(hashedFile), mutants, ['Mutants'])
            threadMinerFoundResults = True
        if len(registryKeys) != 0:
            md += tableToMarkdown("Hashed file: {} Registry keys".format(hashedFile), registryKeys, ['Registry'])
            threadMinerFoundResults = True
        if len(antiVirusDetection) != 0:
            md += tableToMarkdown("Anti Virus detections to hashed file: {}".format(hashedFile), antiVirusDetection, ['av','detection'])
            threadMinerFoundResults = True

        if threadMinerFoundResults == False:
            md += 'No results found'

        return md

    def delete_proxy_if_asked():
        if not demisto.params()['proxy']:
            del os.environ['HTTP_PROXY']
            del os.environ['HTTPS_PROXY']
            del os.environ['http_proxy']
            del os.environ['https_proxy']

    ''' EXECUTION CODE '''
    try:
        demistoCommand = demisto.command()
        if demistoCommand == 'test-module':
            report = get_domain_report('google.com', MAX_RETURNED_ARRAY_SIZE)[0]

            if 'Contents' in report:
                demisto.results('ok')
            else:
                demisto.results('test failed')
            pass

        if demisto.params().get('limitResults').lower() == 'all':
            maxArraySize = -1
        else:
            maxArraySize = int(demisto.params().get('limitResults', MAX_RETURNED_ARRAY_SIZE))

        delete_proxy_if_asked()

        if demistoCommand == 'domain':
            domainName = demisto.args().get('domain')
            demisto.results(get_domain_report(domainName, maxArraySize))
        if demistoCommand == 'ip':
            ipAddress = demisto.args().get('ip')
            if not is_ip_valid(ipAddress):
                return_error('An invalid IP was specified')
            demisto.results(get_ip_report(ipAddress, maxArraySize))
        if demistoCommand == 'file':
            hashedfile = demisto.args().get('file')
            demisto.results(get_file_report(hashedfile, maxArraySize))

    except Exception, e:
        raise
  type: python
  commands:
  - name: domain
    arguments:
    - name: domain
      required: true
      description: Domain name
    outputs:
    - contextPath: ThreatMiner.Domain
      description: Searched domain name
      type: string
    - contextPath: ThreatMiner.Domain.Whois.Server
      description: Whois Server address
      type: string
    - contextPath: ThreatMiner.Domain.Whois.CreateDate
      description: Creation date
      type: date
    - contextPath: ThreatMiner.Domain.Whois.UpdateDate
      description: Last update date
      type: date
    - contextPath: ThreatMiner.Domain.Whois.Expiration
      description: Expiration date
      type: date
    - contextPath: ThreatMiner.Domain.Whois.NameServers
      description: Whois name servers
      type: string
    - contextPath: ThreatMiner.Domain.PassiveDNS.IP
      description: Passive DNS IP address
      type: string
    - contextPath: ThreatMiner.Domain.PassiveDNS.FirstSeen
      description: Passive DNS first seen date
      type: date
    - contextPath: ThreatMiner.Domain.PassiveDNS.LastSeen
      description: Passive DNS last seen date
      type: date
    - contextPath: ThreatMiner.Domain.Subdomains
      description: Subdomains
      type: string
    - contextPath: ThreatMiner.Domain.URI
      description: Related URIs
      type: string
    - contextPath: ThreatMiner.Domain.URI.LastSeen
      description: URI last seen date
      type: string
    - contextPath: ThreatMiner.Domain.MD5
      description: Related samples md5
      type: string
    - contextPath: Domain.Name
    description: Retrieve data from ThreatMiner about a specified domain.
  - name: ip
    arguments:
    - name: ip
      required: true
      description: IP address
    outputs:
    - contextPath: ThreatMiner.IP.Address
      description: Searched IP address
      type: string
    - contextPath: ThreatMiner.IP.Whois.Reverse
      description: Whois reverse name
      type: string
    - contextPath: ThreatMiner.IP.Whois.Bgp
      description: BGP prefix
      type: string
    - contextPath: ThreatMiner.IP.Whois.Country
      description: Related country
      type: string
    - contextPath: ThreatMiner.IP.Whois.ASN
      description: Related ASN
      type: string
    - contextPath: ThreatMiner.IP.Whois.Org
      description: Organization name
      type: string
    - contextPath: ThreatMiner.IP.PassiveDNS.IP
      description: PassiveDNS IP address
      type: string
    - contextPath: ThreatMiner.IP.PassiveDNS.FirstSeen
      description: Passive DNS first seen date
      type: date
    - contextPath: ThreatMiner.IP.PassiveDNS.LastSeen
      description: Passive DNS last seen date
      type: date
    - contextPath: ThreatMiner.IP.URI
      description: Related URIs
      type: string
    - contextPath: ThreatMiner.IP.URI.LastSeen
      description: URI last seen date
      type: date
    - contextPath: ThreatMiner.IP.MD5
      description: Related samples md5
      type: string
    - contextPath: ThreatMiner.IP.SSL
      description: SSL certificates
      type: string
    - contextPath: IP.Geo.Country
      description: ""
    - contextPath: IP.Address
    description: Retrieve data from ThreatMiner about a specified IP address.
  - name: file
    arguments:
    - name: file
      required: true
      description: File hash (md5, sha1, sha256)
    - name: threshold
      description: If ThreatScore is greater or equal than the threshold, then file
        will be considered malicious
      defaultValue: "10"
    outputs:
    - contextPath: ThreatMiner.File.MD5
      description: File md5
      type: string
    - contextPath: ThreatMiner.File.Sha1
      description: File Sha1
      type: string
    - contextPath: ThreatMiner.File.Sha256
      description: File Sha256
      type: string
    - contextPath: ThreatMiner.File.Type
      description: File type
      type: string
    - contextPath: ThreatMiner.File.Name
      description: File name
      type: string
    - contextPath: ThreatMiner.File.Architecture
      description: File architecture
      type: string
    - contextPath: ThreatMiner.File.Size
      description: File size
      type: string
    - contextPath: ThreatMiner.File.Analyzed
      description: File analyzed date
      type: date
    - contextPath: ThreatMiner.File.HTTP.Domain
      description: HTTP traffic to domain
      type: string
    - contextPath: ThreatMiner.File.HTTP.URL
      description: HTTP traffic to URL
      type: string
    - contextPath: ThreatMiner.File.HTTP.Useragent
      description: HTTP user agent
      type: string
    - contextPath: ThreatMiner.File.IP
      description: Related IP addresses
      type: string
    - contextPath: ThreatMiner.File.Domains
      description: Related domains
      type: string
    - contextPath: ThreatMiner.File.Mutants
      description: Used Mutexes
      type: string
    - contextPath: ThreatMiner.File.Registry
      description: Used registry keys
      type: string
    - contextPath: ThreatMiner.File.AV
      description: Detected AV name
      type: string
    - contextPath: ThreatMiner.File.AV.Detection
      description: AV detection
      type: string
    - contextPath: File.MD5
      description: File md5
      type: string
    - contextPath: File.Sha1
      description: File Sha1
      type: string
    - contextPath: File.Sha256
      description: File Sha256
      type: string
    - contextPath: File.Malicious.Detections
      description: For malicious files. Total detections.
      type: number
    - contextPath: File.Malicious.Vendor
      description: For malicious files, the vendor that made the decision
      type: string
    - contextPath: DBotScore.Indicator
      description: The indicator we tested
      type: string
    - contextPath: DBotScore.Score
      description: The actual score
      type: number
    - contextPath: DBotScore.Type
      description: The type of the indicator
      type: string
    - contextPath: DBotScore.Vendor
      description: Vendor used to calculate the score
      type: string
    description: Retrieve data from ThreatMiner about a specified file.
  runonce: false
